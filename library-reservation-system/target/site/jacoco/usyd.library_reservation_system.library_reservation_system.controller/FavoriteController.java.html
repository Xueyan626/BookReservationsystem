<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FavoriteController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">library-reservation-system</a> &gt; <a href="index.source.html" class="el_package">usyd.library_reservation_system.library_reservation_system.controller</a> &gt; <span class="el_source">FavoriteController.java</span></div><h1>FavoriteController.java</h1><pre class="source lang-java linenums">package usyd.library_reservation_system.library_reservation_system.controller;

import lombok.Data;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import usyd.library_reservation_system.library_reservation_system.service.FavoriteService;
import usyd.library_reservation_system.library_reservation_system.dto.BookCardDto;
import java.util.List;
import java.util.Map;
import usyd.library_reservation_system.library_reservation_system.service.FavoriteService;
import usyd.library_reservation_system.library_reservation_system.repository.BookRepository;
import usyd.library_reservation_system.library_reservation_system.model.Book;
import usyd.library_reservation_system.library_reservation_system.model.favorite.FavoriteId;
import jakarta.servlet.http.HttpServletRequest;

@RestController
@RequestMapping(&quot;/api/favorites&quot;)
@CrossOrigin(origins = &quot;*&quot;)
@RequiredArgsConstructor
<span class="fc" id="L23">@Slf4j</span>
public class FavoriteController {

    private final FavoriteService favoriteService;

    @PostMapping(&quot;/toggle&quot;)
    public ResponseEntity&lt;?&gt; toggle(@RequestBody ToggleReq req,
                                    jakarta.servlet.http.HttpServletRequest httpReq) {
        // 统一从 Header 取用户
<span class="fc" id="L32">        String h = httpReq.getHeader(&quot;X-USER-ID&quot;);</span>
<span class="fc bfc" id="L33" title="All 4 branches covered.">        if (h == null || !h.matches(&quot;\\d+&quot;)) {</span>
<span class="fc" id="L34">            return ResponseEntity.status(401)</span>
<span class="fc" id="L35">                    .body(java.util.Map.of(&quot;error&quot;,&quot;UNAUTHORIZED&quot;,&quot;message&quot;,&quot;Missing X-USER-ID header&quot;));</span>
        }
<span class="fc" id="L37">        Integer userId = Integer.valueOf(h);</span>

<span class="fc bfc" id="L39" title="All 2 branches covered.">        if (req.getBookId() == null) {</span>
<span class="fc" id="L40">            return ResponseEntity.badRequest()</span>
<span class="fc" id="L41">                    .body(java.util.Map.of(&quot;error&quot;,&quot;BAD_REQUEST&quot;,&quot;message&quot;,&quot;bookId is required&quot;));</span>
        }
<span class="fc" id="L43">        var result = favoriteService.toggle(userId, req.getBookId());</span>
<span class="fc" id="L44">        return ResponseEntity.ok(result);</span>
    }

    @Data
    public static class ToggleReq {
        private Integer userId;
        private Integer bookId;
    }

    private Integer currentUserIdFromHeader(jakarta.servlet.http.HttpServletRequest req) {
//        String h = req.getHeader(&quot;X-USER-ID&quot;);
//        if (h != null &amp;&amp; h.matches(&quot;\\d+&quot;)) return Integer.valueOf(h);
//        throw new RuntimeException(&quot;Missing X-USER-ID header&quot;);
<span class="fc" id="L57">        String h = req.getHeader(&quot;X-USER-ID&quot;);</span>
<span class="pc bpc" id="L58" title="1 of 4 branches missed.">        return (h != null &amp;&amp; h.matches(&quot;\\d+&quot;)) ? Integer.valueOf(h) : null;</span>
    }

    @GetMapping(&quot;/{bookId}/check&quot;)
    public Map&lt;String, Object&gt; check(@PathVariable Integer bookId,
                                     jakarta.servlet.http.HttpServletRequest req) {
<span class="fc" id="L64">        Integer userId = currentUserIdFromHeader(req);</span>
<span class="fc" id="L65">        boolean favorited = favoriteService.exists(userId, bookId);   // 见 4.2 新增的 exists()</span>
<span class="fc" id="L66">        return Map.of(&quot;favorited&quot;, favorited);</span>
    }

    @DeleteMapping(&quot;/{bookId}&quot;)
    public ResponseEntity&lt;?&gt; remove(@PathVariable Integer bookId,
                                    jakarta.servlet.http.HttpServletRequest req) {
<span class="fc" id="L72">        Integer userId = currentUserIdFromHeader(req);</span>
<span class="fc" id="L73">        favoriteService.remove(userId, bookId);                       // 见 4.2 新增的 remove()</span>
<span class="fc" id="L74">        return ResponseEntity.noContent().build();</span>
    }

    @GetMapping(&quot;&quot;)
    public org.springframework.http.ResponseEntity&lt;?&gt; myFavorites(jakarta.servlet.http.HttpServletRequest req) {
        try {
<span class="fc" id="L80">            Integer userId = currentUserIdFromHeader(req);</span>
<span class="fc" id="L81">            log.info(&quot;GET /api/favorites called, userId={}&quot;, userId);</span>

            // 用 Service 拿书列表
<span class="fc" id="L84">            java.util.List&lt;usyd.library_reservation_system.library_reservation_system.model.Book&gt; books =</span>
<span class="fc" id="L85">                    favoriteService.listBooksByUser(userId);</span>

            // ✅ 只手动挑字段，避免实体序列化问题
<span class="fc" id="L88">            var result = books.stream().map(b -&gt; java.util.Map.of(</span>
<span class="fc" id="L89">                    &quot;bookId&quot;,   b.getBookId(),</span>
<span class="fc" id="L90">                    &quot;bookName&quot;, b.getBookName(),</span>
<span class="fc" id="L91">                    &quot;author&quot;,   b.getAuthor(),</span>
<span class="fc" id="L92">                    &quot;avatar&quot;,   b.getAvatar(),</span>
<span class="fc" id="L93">                    &quot;labelId&quot;,  b.getLabelId()</span>
<span class="fc" id="L94">            )).toList();</span>

<span class="fc" id="L96">            log.info(&quot;GET /api/favorites ok, size={}&quot;, result.size());</span>
<span class="fc" id="L97">            return org.springframework.http.ResponseEntity.ok(result);</span>
<span class="nc" id="L98">        } catch (Exception e) {</span>
<span class="nc" id="L99">            log.error(&quot;GET /api/favorites failed&quot;, e);   // ✅ 一定打印堆栈</span>
<span class="nc" id="L100">            return org.springframework.http.ResponseEntity.status(500).body(java.util.Map.of(</span>
                    &quot;error&quot;, &quot;INTERNAL_ERROR&quot;,
<span class="nc bnc" id="L102" title="All 2 branches missed.">                    &quot;message&quot;, e.getMessage() == null ? &quot;Unexpected error&quot; : e.getMessage()</span>
            ));
        }
    }

    // 可选：批量删除
    @DeleteMapping(&quot;/batch&quot;)
    public ResponseEntity&lt;?&gt; removeBatch(@RequestBody Map&lt;String, List&lt;Integer&gt;&gt; body,
                                         jakarta.servlet.http.HttpServletRequest req) {
<span class="fc" id="L111">        Integer userId = currentUserIdFromHeader(req);</span>
<span class="fc" id="L112">        List&lt;Integer&gt; ids = body.getOrDefault(&quot;bookIds&quot;, List.of());</span>
<span class="fc" id="L113">        ids.forEach(bookId -&gt; favoriteService.remove(userId, bookId));</span>
<span class="fc" id="L114">        return ResponseEntity.noContent().build();</span>
    }

    @PostMapping(&quot;/{id}/favorite&quot;)
    public ResponseEntity&lt;?&gt; incrementFavoriteCount(@PathVariable Integer id,
                                                    jakarta.servlet.http.HttpServletRequest req) {
<span class="fc" id="L120">        String h = req.getHeader(&quot;X-USER-ID&quot;);</span>
<span class="fc bfc" id="L121" title="All 4 branches covered.">        if (h == null || !h.matches(&quot;\\d+&quot;)) {</span>
<span class="fc" id="L122">            return ResponseEntity.status(401)</span>
<span class="fc" id="L123">                    .body(java.util.Map.of(&quot;error&quot;,&quot;UNAUTHORIZED&quot;,&quot;message&quot;,&quot;Missing X-USER-ID header&quot;));</span>
        }
<span class="fc" id="L125">        Integer userId = Integer.valueOf(h);</span>
        try {
<span class="fc" id="L127">            favoriteService.add(userId, id);</span>
<span class="fc" id="L128">            return ResponseEntity.ok().build();</span>
<span class="nc" id="L129">        } catch (org.springframework.dao.DataIntegrityViolationException e) {</span>
<span class="nc" id="L130">            return ResponseEntity.badRequest().body(java.util.Map.of(</span>
                    &quot;error&quot;,&quot;BAD_REQUEST&quot;,&quot;message&quot;,&quot;Invalid userId or bookId (FK/constraint failed)&quot;
            ));
<span class="nc" id="L133">        } catch (Exception e) {</span>
<span class="nc" id="L134">            return ResponseEntity.status(500).body(java.util.Map.of(</span>
<span class="nc" id="L135">                    &quot;error&quot;,&quot;INTERNAL_ERROR&quot;,&quot;message&quot;, e.getMessage()</span>
            ));
        }
    }

    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public Map&lt;String, Object&gt; handleGeneric(Exception ex) {
        // 建议同时在日志里打印
<span class="nc" id="L144">        log.error(&quot;Unhandled exception&quot;, ex);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        return Map.of(&quot;error&quot;, &quot;INTERNAL_ERROR&quot;, &quot;message&quot;, ex.getMessage() == null ? &quot;Unexpected error&quot; : ex.getMessage());</span>
    }



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>