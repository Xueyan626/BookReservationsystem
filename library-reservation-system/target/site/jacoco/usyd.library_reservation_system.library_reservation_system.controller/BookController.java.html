<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">library-reservation-system</a> &gt; <a href="index.source.html" class="el_package">usyd.library_reservation_system.library_reservation_system.controller</a> &gt; <span class="el_source">BookController.java</span></div><h1>BookController.java</h1><pre class="source lang-java linenums">package usyd.library_reservation_system.library_reservation_system.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import usyd.library_reservation_system.library_reservation_system.model.Book;
import usyd.library_reservation_system.library_reservation_system.service.BookService;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;

@RestController
@RequestMapping(&quot;/api/books&quot;)
@CrossOrigin(origins = &quot;*&quot;,
        allowedHeaders = {&quot;*&quot;, &quot;X-USER-ID&quot;},
        exposedHeaders = {&quot;X-USER-ID&quot;},
        methods = {RequestMethod.GET, RequestMethod.POST, RequestMethod.PATCH, RequestMethod.DELETE, RequestMethod.OPTIONS}
)
<span class="fc" id="L30">public class BookController {</span>

    @Autowired
    private BookService bookService;
    @Autowired
    private usyd.library_reservation_system.library_reservation_system.service.FavoriteService favoriteService;


    @GetMapping
    public ResponseEntity&lt;List&lt;Book&gt;&gt; getAllBooks() {
        try {
<span class="fc" id="L41">            List&lt;Book&gt; books = bookService.getAllBooks();</span>
<span class="fc" id="L42">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L43">        } catch (Exception e) {</span>
<span class="nc" id="L44">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;Book&gt; getBookById(@PathVariable Integer id) {
        try {
<span class="fc" id="L52">            Optional&lt;Book&gt; book = bookService.getBookById(id);</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">            if (book.isPresent()) {</span>
<span class="fc" id="L54">                return ResponseEntity.ok(book.get());</span>
            } else {
<span class="fc" id="L56">                return ResponseEntity.notFound().build();</span>
            }
<span class="nc" id="L58">        } catch (Exception e) {</span>
<span class="nc" id="L59">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @PostMapping
    public ResponseEntity&lt;Book&gt; createBook(@RequestBody Book book) {
        try {
<span class="fc" id="L67">            Book createdBook = bookService.createBook(book);</span>
<span class="fc" id="L68">            return ResponseEntity.status(HttpStatus.CREATED).body(createdBook);</span>
<span class="nc" id="L69">        } catch (Exception e) {</span>
<span class="nc" id="L70">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(null);</span>
        }
    }


    @PutMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;Book&gt; updateBook(@PathVariable Integer id, @RequestBody Book bookDetails) {
        try {
<span class="fc" id="L78">            Book updatedBook = bookService.updateBook(id, bookDetails);</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (updatedBook != null) {</span>
<span class="fc" id="L80">                return ResponseEntity.ok(updatedBook);</span>
            } else {
<span class="fc" id="L82">                return ResponseEntity.notFound().build();</span>
            }
<span class="nc" id="L84">        } catch (Exception e) {</span>
<span class="nc" id="L85">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(null);</span>
        }
    }


    @DeleteMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;Void&gt; deleteBook(@PathVariable Integer id) {
        try {
<span class="fc" id="L93">            boolean deleted = bookService.deleteBook(id);</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (deleted) {</span>
<span class="nc" id="L95">                return ResponseEntity.noContent().build();</span>
            } else {
<span class="fc" id="L97">                return ResponseEntity.notFound().build();</span>
            }
<span class="nc" id="L99">        } catch (Exception e) {</span>
<span class="nc" id="L100">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
        }
    }


    @GetMapping(&quot;/search&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; searchBooks(@RequestParam String keyword) {
        try {
<span class="fc" id="L108">            List&lt;Book&gt; books = bookService.searchBooks(keyword);</span>
<span class="fc" id="L109">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/search/name&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; searchBooksByName(@RequestParam String name) {
        try {
<span class="fc" id="L119">            List&lt;Book&gt; books = bookService.searchBooksByName(name);</span>
<span class="fc" id="L120">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L121">        } catch (Exception e) {</span>
<span class="nc" id="L122">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/search/author&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; searchBooksByAuthor(@RequestParam String author) {
        try {
<span class="fc" id="L130">            List&lt;Book&gt; books = bookService.searchBooksByAuthor(author);</span>
<span class="fc" id="L131">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L132">        } catch (Exception e) {</span>
<span class="nc" id="L133">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/label/{labelId}&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; getBooksByLabelId(@PathVariable Integer labelId) {
        try {
<span class="fc" id="L141">            List&lt;Book&gt; books = bookService.getBooksByLabelId(labelId);</span>
<span class="fc" id="L142">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L143">        } catch (Exception e) {</span>
<span class="nc" id="L144">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/available&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; getAvailableBooks() {
        try {
<span class="fc" id="L152">            List&lt;Book&gt; books = bookService.getAvailableBooks();</span>
<span class="fc" id="L153">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L154">        } catch (Exception e) {</span>
<span class="nc" id="L155">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/popular&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; getMostPopularBooks() {
        try {
<span class="fc" id="L163">            List&lt;Book&gt; books = bookService.getMostPopularBooks();</span>
<span class="fc" id="L164">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L165">        } catch (Exception e) {</span>
<span class="nc" id="L166">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @GetMapping(&quot;/most-reserved&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; getMostReservedBooks() {
        try {
<span class="fc" id="L174">            List&lt;Book&gt; books = bookService.getMostReservedBooks();</span>
<span class="fc" id="L175">            return ResponseEntity.ok(books);</span>
<span class="nc" id="L176">        } catch (Exception e) {</span>
<span class="nc" id="L177">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }


    @PatchMapping(&quot;/{id}/quantity&quot;)
    public ResponseEntity&lt;Book&gt; updateBookQuantity(@PathVariable Integer id, @RequestBody QuantityRequest request) {
        try {
<span class="fc" id="L185">            Book updatedBook = bookService.updateBookQuantity(id, request.getQuantity());</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">            if (updatedBook != null) {</span>
<span class="fc" id="L187">                return ResponseEntity.ok(updatedBook);</span>
            } else {
<span class="fc" id="L189">                return ResponseEntity.notFound().build();</span>
            }
<span class="nc" id="L191">        } catch (Exception e) {</span>
<span class="nc" id="L192">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(null);</span>
        }
    }


    @PostMapping(&quot;/{id}/favorite&quot;)
    public ResponseEntity&lt;?&gt; incrementFavoriteCount(
            @PathVariable Integer id,
            jakarta.servlet.http.HttpServletRequest req
    ) {
<span class="fc" id="L202">        String h = req.getHeader(&quot;X-USER-ID&quot;);</span>
<span class="fc bfc" id="L203" title="All 4 branches covered.">        if (h == null || !h.matches(&quot;\\d+&quot;)) {</span>
<span class="fc" id="L204">            return ResponseEntity.status(401)</span>
<span class="fc" id="L205">                    .body(java.util.Map.of(&quot;error&quot;,&quot;UNAUTHORIZED&quot;,&quot;message&quot;,&quot;Missing X-USER-ID header&quot;));</span>
        }
<span class="fc" id="L207">        Integer userId = Integer.valueOf(h);</span>

        try {
<span class="fc" id="L210">            favoriteService.add(userId, id);   // ‚Üê Áî®Â≠óÊÆµÊ≥®ÂÖ•ÁöÑ service</span>
<span class="fc" id="L211">            return ResponseEntity.ok().build();</span>
<span class="nc" id="L212">        } catch (org.springframework.dao.DataIntegrityViolationException e) {</span>
<span class="nc" id="L213">            e.printStackTrace();</span>
<span class="nc" id="L214">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L215">                    .body(java.util.Map.of(&quot;error&quot;,&quot;BAD_REQUEST&quot;,</span>
                            &quot;message&quot;,&quot;Invalid userId or bookId (FK/constraint failed)&quot;));
<span class="nc" id="L217">        } catch (Exception e) {</span>
<span class="nc" id="L218">            e.printStackTrace();</span>
<span class="nc" id="L219">            return ResponseEntity.status(500)</span>
<span class="nc" id="L220">                    .body(java.util.Map.of(&quot;error&quot;,&quot;INTERNAL_ERROR&quot;,&quot;message&quot;, e.getMessage()));</span>
        }
    }


    @PostMapping(&quot;/{id}/reservation&quot;)
    public ResponseEntity&lt;Book&gt; incrementReservationCount(@PathVariable Integer id) {
        try {
<span class="fc" id="L228">            Book updatedBook = bookService.incrementReservationCount(id);</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">            if (updatedBook != null) {</span>
<span class="fc" id="L230">                return ResponseEntity.ok(updatedBook);</span>
            } else {
<span class="fc" id="L232">                return ResponseEntity.notFound().build();</span>
            }
<span class="nc" id="L234">        } catch (Exception e) {</span>
<span class="nc" id="L235">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(null);</span>
        }
    }


<span class="fc" id="L240">    public static class QuantityRequest {</span>
        private Integer quantity;

        public Integer getQuantity() {
<span class="fc" id="L244">            return quantity;</span>
        }

        public void setQuantity(Integer quantity) {
<span class="fc" id="L248">            this.quantity = quantity;</span>
<span class="fc" id="L249">        }</span>
    }


    @GetMapping(&quot;/search-by-label&quot;)
    public ResponseEntity&lt;List&lt;BookService.BookSimpleDto&gt;&gt; searchByLabel(@RequestParam(&quot;q&quot;) String q) {
        try {
<span class="fc" id="L256">            var result = bookService.searchByLabelName(q);</span>
<span class="fc" id="L257">            return ResponseEntity.ok(result);</span>
<span class="nc" id="L258">        } catch (Exception e) {</span>
<span class="nc" id="L259">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);</span>
        }
    }

//    @PostMapping(&quot;/{id}/favorite&quot;)
//    public ResponseEntity&lt;?&gt; addFavorite(@PathVariable Integer id,
//                                         javax.servlet.http.HttpServletRequest req,
//                                         usyd.library_reservation_system.library_reservation_system.service.FavoriteService favoriteService) {
//        Integer userId = Integer.valueOf(req.getHeader(&quot;X-USER-ID&quot;)); // ‰∏é FavoriteController ÁöÑÂèñÊ≥ï‰∏ÄËá¥
//        favoriteService.add(userId, id);
//        return ResponseEntity.ok().build();
//    }

    /**
     * Upload book cover image
     */
    @PostMapping(&quot;/cover&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; uploadCover(@RequestParam(&quot;file&quot;) MultipartFile file) {
<span class="fc" id="L277">        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</span>
        
<span class="fc" id="L279">        System.out.println(&quot;üì§ Received upload request - File: &quot; + file.getOriginalFilename() + &quot;, Size: &quot; + file.getSize());</span>
        
<span class="pc bpc" id="L281" title="1 of 4 branches missed.">        if (file == null || file.isEmpty()) {</span>
<span class="fc" id="L282">            System.out.println(&quot;‚ùå Error: No file uploaded&quot;);</span>
<span class="fc" id="L283">            response.put(&quot;error&quot;, &quot;No file uploaded&quot;);</span>
<span class="fc" id="L284">            return ResponseEntity.badRequest().body(response);</span>
        }
        
        try {
            // Generate unique filename
<span class="fc" id="L289">            String originalFilename = file.getOriginalFilename();</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">            if (originalFilename == null) {</span>
<span class="nc" id="L291">                originalFilename = &quot;unknown&quot;;</span>
            }
<span class="fc" id="L293">            System.out.println(&quot;üìù Original filename: &quot; + originalFilename);</span>
            
<span class="fc" id="L295">            String extension = &quot;&quot;;</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">            if (originalFilename.contains(&quot;.&quot;)) {</span>
<span class="fc" id="L297">                extension = originalFilename.substring(originalFilename.lastIndexOf(&quot;.&quot;));</span>
            }
<span class="fc" id="L299">            String filename = UUID.randomUUID().toString() + extension;</span>
<span class="fc" id="L300">            System.out.println(&quot;üìù Generated filename: &quot; + filename);</span>
            
            // Try multiple possible paths
<span class="fc" id="L303">            String webappPath = null;</span>
<span class="fc" id="L304">            String userDir = System.getProperty(&quot;user.dir&quot;);</span>
<span class="fc" id="L305">            System.out.println(&quot;üîç Current working directory: &quot; + userDir);</span>
            
<span class="fc" id="L307">            String[] possiblePaths = {</span>
                userDir + File.separator + &quot;src&quot; + File.separator + &quot;main&quot; + File.separator + &quot;webapp&quot;,
                userDir + File.separator + &quot;library-reservation-system&quot; + File.separator + &quot;src&quot; + File.separator + &quot;main&quot; + File.separator + &quot;webapp&quot;,
                &quot;src/main/webapp&quot;,
                &quot;library-reservation-system/src/main/webapp&quot;
            };
            
<span class="fc bfc" id="L314" title="All 2 branches covered.">            for (String path : possiblePaths) {</span>
<span class="fc" id="L315">                File testPath = new File(path);</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">                System.out.println(&quot;üîç Testing path: &quot; + path + &quot; -&gt; &quot; + (testPath.exists() ? &quot;EXISTS&quot; : &quot;NOT FOUND&quot;));</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">                if (testPath.exists()) {</span>
<span class="nc" id="L318">                    webappPath = path;</span>
<span class="nc" id="L319">                    break;</span>
                }
            }
            
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">            if (webappPath == null) {</span>
<span class="fc" id="L324">                webappPath = userDir;</span>
<span class="fc" id="L325">                System.out.println(&quot;‚ö†Ô∏è No webapp path found, using: &quot; + webappPath);</span>
            }
            
<span class="fc" id="L328">            System.out.println(&quot;üìÇ Using webapp path: &quot; + webappPath);</span>
            
            // Define upload directory - direct path to covers
<span class="fc" id="L331">            String uploadDir = webappPath + File.separator + &quot;resource&quot; + File.separator + </span>
                             &quot;img&quot; + File.separator + &quot;covers&quot; + File.separator;
            
<span class="fc" id="L334">            System.out.println(&quot;üìÇ Upload directory: &quot; + uploadDir);</span>
            
<span class="fc" id="L336">            File uploadPath = new File(uploadDir);</span>
            
            // Create directory if it doesn't exist
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">            if (!uploadPath.exists()) {</span>
<span class="fc" id="L340">                boolean created = uploadPath.mkdirs();</span>
<span class="fc" id="L341">                System.out.println(&quot;üìÅ Directory created: &quot; + created);</span>
            }
            
            // Save file
<span class="fc" id="L345">            Path filePath = Paths.get(uploadDir + filename);</span>
<span class="fc" id="L346">            System.out.println(&quot;üíæ Saving file to: &quot; + filePath.toAbsolutePath());</span>
            
<span class="fc" id="L348">            Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);</span>
            
            // Return the path in the same format as existing books: /img/covers/filename.jpg
<span class="fc" id="L351">            String avatarPath = &quot;/img/covers/&quot; + filename;</span>
<span class="fc" id="L352">            response.put(&quot;filename&quot;, avatarPath);</span>
<span class="fc" id="L353">            response.put(&quot;success&quot;, &quot;true&quot;);</span>
            
<span class="fc" id="L355">            System.out.println(&quot;‚úÖ Cover uploaded successfully: &quot; + avatarPath);</span>
            
<span class="fc" id="L357">            return ResponseEntity.ok(response);</span>
            
<span class="nc" id="L359">        } catch (IOException e) {</span>
<span class="nc" id="L360">            e.printStackTrace();</span>
<span class="nc" id="L361">            System.err.println(&quot;‚ùå Upload failed: &quot; + e.getMessage());</span>
<span class="nc" id="L362">            response.put(&quot;error&quot;, &quot;Failed to upload file: &quot; + e.getMessage());</span>
<span class="nc" id="L363">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);</span>
<span class="nc" id="L364">        } catch (Exception e) {</span>
<span class="nc" id="L365">            e.printStackTrace();</span>
<span class="nc" id="L366">            System.err.println(&quot;‚ùå Unexpected error: &quot; + e.getMessage());</span>
<span class="nc" id="L367">            response.put(&quot;error&quot;, &quot;Unexpected error: &quot; + e.getMessage());</span>
<span class="nc" id="L368">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>