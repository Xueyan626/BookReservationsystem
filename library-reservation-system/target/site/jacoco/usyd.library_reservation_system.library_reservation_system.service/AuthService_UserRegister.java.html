<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthService_UserRegister.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">library-reservation-system</a> &gt; <a href="index.source.html" class="el_package">usyd.library_reservation_system.library_reservation_system.service</a> &gt; <span class="el_source">AuthService_UserRegister.java</span></div><h1>AuthService_UserRegister.java</h1><pre class="source lang-java linenums">package usyd.library_reservation_system.library_reservation_system.service;

import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import usyd.library_reservation_system.library_reservation_system.dto.*;
import usyd.library_reservation_system.library_reservation_system.model.UserEntity;
import usyd.library_reservation_system.library_reservation_system.repository.UserRepository;

import java.time.Instant;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ThreadLocalRandom;

@Service
@RequiredArgsConstructor
@Transactional
public class AuthService_UserRegister {

    private final UserRepository userRepository;
    private final EmailService emailService;       // 你已有：三参 sendRegisterCode
    private final TokenService tokenService;       // 你已有：sign(Map, Instant)/verify(String)
    private final PasswordEncoder passwordEncoder; // 来自 SecurityBeans

    @Value(&quot;${app.login.code-ttl-minutes:10}&quot;)
    private int ttlMinutes;                        // 方案B：由调用方传递/或这里注入

    @Value(&quot;${app.login.code-length:6}&quot;)
    private int codeLength;

    // 第一步：发送验证码（不入库）
    public RegisterStartResponse startRegister(RegisterStartRequest req) {
<span class="fc" id="L35">        final String email = req.getEmail().trim().toLowerCase();</span>

        // 生成数字验证码
<span class="fc" id="L38">        String code = randomDigits(codeLength);</span>

        // 用你项目的 TokenService(JJWT) 生成 challengeToken（包含 email + code），并设置过期时间
<span class="fc" id="L41">        Map&lt;String, Object&gt; claims = new HashMap&lt;&gt;();</span>
<span class="fc" id="L42">        claims.put(&quot;email&quot;, email);</span>
<span class="fc" id="L43">        claims.put(&quot;code&quot;, code);</span>
<span class="fc" id="L44">        Instant expiresAt = Instant.now().plusSeconds(ttlMinutes * 60L);</span>
<span class="fc" id="L45">        String challengeToken = tokenService.sign(claims, expiresAt);</span>

        // 发送邮件（方案B：显式传 ttlMinutes）
<span class="fc" id="L48">        emailService.sendRegisterCode(email, code, ttlMinutes);</span>

<span class="fc" id="L50">        return RegisterStartResponse.builder()</span>
<span class="fc" id="L51">                .challengeToken(challengeToken)</span>
<span class="fc" id="L52">                .ttlMinutes(ttlMinutes)</span>
<span class="fc" id="L53">                .build();</span>
    }

    // 第二步：提交注册（校验 token + code + 两次密码一致，哈希存储）
    public UserProfileDTO submitRegister(RegisterSubmitRequest req) {
        // 1) 校验 challenge（内部会校验签名 &amp; 过期）
        Map&lt;String, Object&gt; payload;
        try {
<span class="fc" id="L61">            payload = tokenService.verify(req.getChallengeToken());</span>
<span class="fc" id="L62">        }catch (IllegalArgumentException e) {           // 就是这里导致的 500</span>
            // 打出真正原因，例如 &quot;expired&quot; / &quot;bad signature&quot; / &quot;bad token&quot;
<span class="fc" id="L64">            throw new InvalidCredentialsException(e.getMessage());  // 交给全局异常返回 400</span>
<span class="fc" id="L65">        }</span>

<span class="fc" id="L67">        String tokenEmail = String.valueOf(payload.get(&quot;email&quot;));</span>
<span class="fc" id="L68">        String tokenCode  = String.valueOf(payload.get(&quot;code&quot;));</span>

        // 2) 防止邮箱被篡改
<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (!tokenEmail.equalsIgnoreCase(req.getEmail().trim())) {</span>
<span class="fc" id="L72">            throw new InvalidCredentialsException(&quot;email&quot;, &quot;email mismatch&quot;);</span>
        }

        // 3) 校验验证码一致
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (!tokenCode.equals(req.getCode().trim())) {</span>
<span class="fc" id="L77">            throw new InvalidCredentialsException(&quot;code mismatch&quot;);</span>
        }

        // 4) 两次密码一致
<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (!req.getPassword().equals(req.getConfirmPassword())) {</span>
<span class="fc" id="L82">            throw new InvalidCredentialsException(&quot;password not match&quot;);</span>
        }

        // 5) 生成哈希（BCrypt）
<span class="fc" id="L86">        String hash = passwordEncoder.encode(req.getPassword());</span>

        // 6) 入库
<span class="fc" id="L89">        UserEntity u = new UserEntity();</span>
<span class="fc" id="L90">        u.setNickname(req.getNickname());</span>
<span class="fc" id="L91">        u.setEmail(req.getEmail().trim().toLowerCase());</span>
<span class="fc" id="L92">        u.setTelephone(req.getTelephone());      // ← 这里用 telephone</span>
<span class="fc" id="L93">        u.setPasswordHash(hash);                 // ← 这里用 passwordHash</span>
<span class="fc" id="L94">        u.setIsActive(Boolean.TRUE);</span>
<span class="fc" id="L95">        userRepository.save(u);</span>

        // 7) 返回给前端的简要资料（按你项目里的 DTO 字段来）
<span class="fc" id="L98">        UserProfileDTO dto = new UserProfileDTO();</span>
<span class="fc" id="L99">        dto.setUserId(u.getUserId());</span>
<span class="fc" id="L100">        dto.setNickname(u.getNickname());</span>
<span class="fc" id="L101">        dto.setEmail(u.getEmail());</span>
<span class="fc" id="L102">        dto.setTelephone(u.getTelephone());</span>
<span class="fc" id="L103">        return dto;</span>
    }


    private String randomDigits(int len) {
<span class="fc" id="L108">        var r = ThreadLocalRandom.current();</span>
<span class="fc" id="L109">        var sb = new StringBuilder(len);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        for (int i = 0; i &lt; len; i++) sb.append(r.nextInt(10));</span>
<span class="fc" id="L111">        return sb.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>